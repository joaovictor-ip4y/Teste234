name: Run PHPUnit with Coverage and PR Comments

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Checkout do cÃ³digo
      - name: Checkout code
        uses: actions/checkout@v3

      # ConfiguraÃ§Ã£o do PHP
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: xdebug

      # InstalaÃ§Ã£o das dependÃªncias do Composer
      - name: Install dependencies
        run: |
          composer install

      # Executa os testes PHPUnit
      - name: Run PHPUnit tests with coverage
        run: |
          vendor/bin/phpunit --coverage-clover=coverage.xml

      # Verificar a cobertura do cÃ³digo
      - name: Check coverage
        id: coverage
        run: |
          COVERAGE=$(php -r "
              libxml_use_internal_errors(true);
              \$xml = simplexml_load_file('coverage.xml');
              if (\$xml === false) {
                  echo 'Erro ao carregar o arquivo coverage.xml';
                  exit(1);
              }
              // Calcula a cobertura como (coveredelements / elements) * 100
              \$coverage = (\$xml->project->metrics['coveredelements'] / \$xml->project->metrics['elements']) * 100;
              echo \$coverage;
          ")
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV

      # Adicionar comentÃ¡rio na PR
      - name: Post comment on PR
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COVERAGE: ${{ env.COVERAGE }}
        run: |
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
          -H "Content-Type: application/json" \
          -d "$(jq -n --arg body "### PHPUnit Test Results ðŸš€\n\n- **Coverage:** ${COVERAGE}%\n\n:warning: Acompanhe a cobertura para garantir qualidade!" '{body: $body}')" \
          "${{ github.event.pull_request.url }}/comments"
